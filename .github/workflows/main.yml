# Read more about setting it up
# https://medium.com/@ljmocic/deploying-react-application-to-aws-s3-using-github-actions-85addacaeace

name: Deploy Django app
on:
  # Trigger the workflow on push or pull request,
  # but only for the master branch

  push:
    branches: [ main ]
  #pull_request:
  #  branches: [ main ]

jobs:
  deploy:
    name: Build phase
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        id: clone-repository
        uses: actions/checkout@main
      - name: running docker info
        uses: ironhalik/docker-over-ssh-action@v1
        with:
          user: ${{ secrets.SERVER_USERNAME }}
          host: ${{ secrets.SERVER_IP }}
          key: ${{ secrets.KEY }}
          # port: 1022 # Defaults to 22
          script: |
            docker info
            docker stack deploy --compose-file=docker-compose.yml stack
        # - name: Push to server
        # uses: appleboy/ssh-action@master
        # env:
        #   RDS_LOGIN_DB: postgres
        #   RDS_HOST: db
        #   RDS_USER: admin
        #   RDS_PASSWORD: admin
        #   RDS_DATABASE: chatBackend
        #   RDS_PORT:  5432
        #   PGADMIN_DEFAULT_EMAIL: user@domain.com
        #   PGADMIN_DEFAULT_PASSWORD: SuperSecret
        # with: 
        #   host: ${{ secrets.SERVER_IP }}
        #   username: ${{ secrets.SERVER_USERNAME }}
        #   key: ${{ secrets.KEY }}
        #   # passphrase: ${{ secrets.PASSPHRASE }} 
        #   script: cd ${{ secrets.PROJECT_PATH }} && git pull

      # - name: Stop containers
      #   if: always()
      #   run: cd ${{ secrets.PROJECT_PATH }} && docker-compose -f "docker-compose.yml" down
      - name: Start containers
        run: cd ${{ secrets.PROJECT_PATH }} && docker-compose -f "docker-compose.yml" up -d --build
