# Read more about setting it up
# https://medium.com/@ljmocic/deploying-react-application-to-aws-s3-using-github-actions-85addacaeace

name: Deploy Django app
on:
  # Trigger the workflow on push or pull request,
  # but only for the master branch

  push:
    branches: [ main ]
  #pull_request:
  #  branches: [ main ]

jobs:
  deploy:
    name: Build phase
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        id: clone-repository
        uses: actions/checkout@main
      - name: Push to server
        uses: appleboy/ssh-action@master
        env:
          RDS_LOGIN_DB: "postgres"
          RDS_HOST: "db"
          RDS_USER: "admin"
          RDS_PASSWORD: "admin"
          RDS_DATABASE: "chatBackend"
          RDS_PORT:  "5432"
          PGADMIN_DEFAULT_EMAIL: "user@domain.com"
          PGADMIN_DEFAULT_PASSWORD: "SuperSecret"
        with: 
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.KEY }}
          # passphrase: ${{ secrets.PASSPHRASE }} 
          envs: RDS_LOGIN_DB,RDS_HOST,RDS_USER, RDS_PASSWORD,RDS_DATABASE,RDS_PORT,PGADMIN_DEFAULT_EMAIL,PGADMIN_DEFAULT_PASSWORD
          script: cd ${{ secrets.PROJECT_PATH }} && git pull && docker-compose -f "docker-compose.yml" up -d --build

      # - name: Stop containers
      #   if: always()
      #   run: cd ${{ secrets.PROJECT_PATH }} && docker-compose -f "docker-compose.yml" down
      # - name: Start containers
      #   run: cd ${{ secrets.PROJECT_PATH }} && docker-compose -f "docker-compose.yml" up -d --build
